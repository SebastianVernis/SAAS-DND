# ğŸ”„ Flujo de Despliegue - SAAS-DND en Google Cloud Run

**Diagrama visual del proceso completo de despliegue**

---

## ğŸ“Š Flujo General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INICIO DEL DESPLIEGUE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 1: PRERREQUISITOS                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âœ“ Cuenta Google Cloud                                    â”‚   â”‚
â”‚  â”‚ âœ“ FacturaciÃ³n habilitada                                 â”‚   â”‚
â”‚  â”‚ âœ“ gcloud CLI instalado                                   â”‚   â”‚
â”‚  â”‚ âœ“ Docker instalado (opcional)                            â”‚   â”‚
â”‚  â”‚ âœ“ Node.js 18+                                            â”‚   â”‚
â”‚  â”‚ âœ“ Credenciales preparadas (JWT, SMTP, DB)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 2: CONFIGURACIÃ“N GCP                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Habilitar APIs                                        â”‚   â”‚
â”‚  â”‚    â€¢ Cloud Build                                         â”‚   â”‚
â”‚  â”‚    â€¢ Cloud Run                                           â”‚   â”‚
â”‚  â”‚    â€¢ Cloud SQL                                           â”‚   â”‚
â”‚  â”‚    â€¢ Secret Manager                                      â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 2. Crear Service Accounts                               â”‚   â”‚
â”‚  â”‚    â€¢ saas-dnd-backend-sa                                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 3. Configurar Cloud SQL                                 â”‚   â”‚
â”‚  â”‚    â€¢ Instancia PostgreSQL 15                            â”‚   â”‚
â”‚  â”‚    â€¢ Base de datos: saasdnd                             â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 4. Almacenar Secretos                                   â”‚   â”‚
â”‚  â”‚    â€¢ JWT_SECRET                                         â”‚   â”‚
â”‚  â”‚    â€¢ DATABASE_URL                                       â”‚   â”‚
â”‚  â”‚    â€¢ SMTP_USER / SMTP_PASS                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  Script: ./scripts/cloud-run/setup-gcp.sh                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 3: BUILD & DEPLOY                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ BACKEND                          FRONTEND                â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚ â”‚ 1. Build Image   â”‚            â”‚ 1. Build React   â”‚    â”‚   â”‚
â”‚  â”‚ â”‚    Docker        â”‚            â”‚    App (Vite)    â”‚    â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚          â”‚                               â”‚              â”‚   â”‚
â”‚  â”‚          â–¼                               â–¼              â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚ â”‚ 2. Push to GCR   â”‚            â”‚ 2. Build Image   â”‚    â”‚   â”‚
â”‚  â”‚ â”‚    Container     â”‚            â”‚    with Nginx    â”‚    â”‚   â”‚
â”‚  â”‚ â”‚    Registry      â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚              â”‚   â”‚
â”‚  â”‚          â”‚                               â–¼              â”‚   â”‚
â”‚  â”‚          â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚          â”‚                      â”‚ 3. Push to GCR   â”‚    â”‚   â”‚
â”‚  â”‚          â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚          â”‚                               â”‚              â”‚   â”‚
â”‚  â”‚          â–¼                               â–¼              â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚ â”‚ 3. Deploy to     â”‚            â”‚ 4. Deploy to     â”‚    â”‚   â”‚
â”‚  â”‚ â”‚    Cloud Run     â”‚            â”‚    Cloud Run     â”‚    â”‚   â”‚
â”‚  â”‚ â”‚    â€¢ Port 8080   â”‚            â”‚    â€¢ Port 8080   â”‚    â”‚   â”‚
â”‚  â”‚ â”‚    â€¢ 512Mi RAM   â”‚            â”‚    â€¢ 256Mi RAM   â”‚    â”‚   â”‚
â”‚  â”‚ â”‚    â€¢ Secrets     â”‚            â”‚    â€¢ Static      â”‚    â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  Script: ./scripts/cloud-run/deploy.sh                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 4: MIGRACIÃ“N DE BASE DE DATOS                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Instalar Cloud SQL Proxy                             â”‚   â”‚
â”‚  â”‚    â†“                                                     â”‚   â”‚
â”‚  â”‚ 2. Conectar a Cloud SQL                                 â”‚   â”‚
â”‚  â”‚    â†“                                                     â”‚   â”‚
â”‚  â”‚ 3. Ejecutar Migraciones (Drizzle)                       â”‚   â”‚
â”‚  â”‚    â€¢ Crear tablas                                       â”‚   â”‚
â”‚  â”‚    â€¢ Aplicar schema                                     â”‚   â”‚
â”‚  â”‚    â†“                                                     â”‚   â”‚
â”‚  â”‚ 4. Verificar Schema                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  Script: ./scripts/cloud-run/migrate-db.sh                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASE 5: VERIFICACIÃ“N                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âœ“ Health checks                                          â”‚   â”‚
â”‚  â”‚ âœ“ Logs sin errores                                       â”‚   â”‚
â”‚  â”‚ âœ“ Frontend accesible                                     â”‚   â”‚
â”‚  â”‚ âœ“ Backend API responde                                   â”‚   â”‚
â”‚  â”‚ âœ“ Base de datos conectada                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    âœ… DESPLIEGUE COMPLETO                        â”‚
â”‚                                                                  â”‚
â”‚  URLs Generadas:                                                 â”‚
â”‚  â€¢ Frontend: https://saas-dnd-frontend-xxx.run.app              â”‚
â”‚  â€¢ Backend:  https://saas-dnd-backend-xxx.run.app               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Detalle de Cada Fase

### FASE 1: Prerrequisitos (15-30 min)

**Objetivo:** Preparar el entorno local y GCP

**Tareas:**
1. Crear cuenta Google Cloud
2. Habilitar facturaciÃ³n
3. Instalar herramientas (gcloud, docker, node)
4. Generar credenciales (JWT, SMTP, DB password)

**VerificaciÃ³n:**
```bash
./scripts/cloud-run/check-prerequisites.sh
```

**DocumentaciÃ³n:**
- `PREREQUISITES.md` - GuÃ­a completa
- `QUICK_START_PREREQUISITES.md` - GuÃ­a rÃ¡pida

---

### FASE 2: ConfiguraciÃ³n GCP (10-15 min)

**Objetivo:** Configurar recursos en Google Cloud

**Recursos Creados:**

```
Google Cloud Project
â”œâ”€â”€ APIs Habilitadas
â”‚   â”œâ”€â”€ Cloud Build
â”‚   â”œâ”€â”€ Cloud Run
â”‚   â”œâ”€â”€ Container Registry
â”‚   â”œâ”€â”€ Cloud SQL Admin
â”‚   â””â”€â”€ Secret Manager
â”‚
â”œâ”€â”€ Service Accounts
â”‚   â””â”€â”€ saas-dnd-backend-sa
â”‚       â”œâ”€â”€ Role: cloudsql.client
â”‚       â””â”€â”€ Role: secretmanager.secretAccessor
â”‚
â”œâ”€â”€ Cloud SQL
â”‚   â””â”€â”€ saas-dnd-db (PostgreSQL 15)
â”‚       â”œâ”€â”€ Tier: db-f1-micro
â”‚       â”œâ”€â”€ Storage: 10GB SSD
â”‚       â””â”€â”€ Database: saasdnd
â”‚
â””â”€â”€ Secret Manager
    â”œâ”€â”€ JWT_SECRET
    â”œâ”€â”€ DATABASE_URL
    â”œâ”€â”€ SMTP_USER
    â””â”€â”€ SMTP_PASS
```

**Script:**
```bash
cd scripts/cloud-run
./setup-gcp.sh
```

**Salida:**
- Service accounts creados
- Cloud SQL configurado
- Secretos almacenados
- Archivo `.env.gcp` generado

---

### FASE 3: Build & Deploy (15-20 min)

**Objetivo:** Construir y desplegar servicios

#### Backend Deployment Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Source Code    â”‚
â”‚  (Express.js)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dockerfile     â”‚
â”‚  Multi-stage    â”‚
â”‚  Build          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Image   â”‚
â”‚  Node 18 Alpine â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Push to GCR    â”‚
â”‚  gcr.io/...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloud Run      â”‚
â”‚  Deploy         â”‚
â”‚  â€¢ Port: 8080   â”‚
â”‚  â€¢ CPU: 1       â”‚
â”‚  â€¢ RAM: 512Mi   â”‚
â”‚  â€¢ Secrets      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Frontend Deployment Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Source Code    â”‚
â”‚  (React + Vite) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  npm run build  â”‚
â”‚  (Production)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Static Files   â”‚
â”‚  dist/          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dockerfile     â”‚
â”‚  Nginx Server   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Image   â”‚
â”‚  Nginx Alpine   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Push to GCR    â”‚
â”‚  gcr.io/...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloud Run      â”‚
â”‚  Deploy         â”‚
â”‚  â€¢ Port: 8080   â”‚
â”‚  â€¢ CPU: 1       â”‚
â”‚  â€¢ RAM: 256Mi   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Script:**
```bash
./deploy.sh
```

**Opciones de Despliegue:**

1. **AutomÃ¡tico (Recomendado):**
   ```bash
   ./deploy.sh
   ```

2. **Cloud Build (CI/CD):**
   ```bash
   gcloud builds submit --config=cloudbuild.yaml
   ```

3. **Manual:**
   ```bash
   # Backend
   cd backend
   docker build -t gcr.io/PROJECT_ID/saas-dnd-backend .
   docker push gcr.io/PROJECT_ID/saas-dnd-backend
   gcloud run deploy saas-dnd-backend --image gcr.io/PROJECT_ID/saas-dnd-backend
   
   # Frontend
   cd apps/web
   docker build -t gcr.io/PROJECT_ID/saas-dnd-frontend .
   docker push gcr.io/PROJECT_ID/saas-dnd-frontend
   gcloud run deploy saas-dnd-frontend --image gcr.io/PROJECT_ID/saas-dnd-frontend
   ```

---

### FASE 4: MigraciÃ³n de Base de Datos (5-10 min)

**Objetivo:** Aplicar schema a Cloud SQL

**Flujo:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Local Machine      â”‚
â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cloud SQL     â”‚  â”‚
â”‚  â”‚ Proxy         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Secure Tunnel
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Cloud       â”‚
â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cloud SQL     â”‚  â”‚
â”‚  â”‚ PostgreSQL    â”‚  â”‚
â”‚  â”‚               â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚ â”‚ Tables  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Schema  â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Data    â”‚   â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Script:**
```bash
./migrate-db.sh
```

**Pasos:**
1. Descargar Cloud SQL Proxy
2. Iniciar proxy en background
3. Ejecutar `npm run db:push` (Drizzle)
4. Verificar schema
5. Detener proxy

**Tablas Creadas:**
- `users` - Usuarios del sistema
- `organizations` - Organizaciones/empresas
- `subscriptions` - Suscripciones activas
- `payments` - Historial de pagos
- `sessions` - Sesiones de usuario
- `otp_codes` - CÃ³digos de verificaciÃ³n

---

### FASE 5: VerificaciÃ³n (5 min)

**Objetivo:** Confirmar que todo funciona

**Checklist:**

```bash
# 1. Verificar servicios desplegados
gcloud run services list

# 2. Health check backend
curl https://BACKEND_URL/health
# Esperado: {"status":"ok","timestamp":"..."}

# 3. Health check frontend
curl https://FRONTEND_URL/health
# Esperado: 200 OK

# 4. Verificar logs
gcloud run services logs read saas-dnd-backend --limit 50
gcloud run services logs read saas-dnd-frontend --limit 50

# 5. Probar en navegador
# Abrir: https://FRONTEND_URL
# Verificar: PÃ¡gina de login carga correctamente

# 6. Probar API
curl https://BACKEND_URL/api/health
# Esperado: {"status":"healthy"}
```

**MÃ©tricas a Verificar:**

| MÃ©trica | Esperado | Comando |
|---------|----------|---------|
| Services Running | 2 | `gcloud run services list` |
| Backend Status | READY | `gcloud run services describe saas-dnd-backend` |
| Frontend Status | READY | `gcloud run services describe saas-dnd-frontend` |
| Database Status | RUNNABLE | `gcloud sql instances describe saas-dnd-db` |
| Error Rate | 0% | Ver logs |

---

## ğŸ”„ Flujo de ActualizaciÃ³n

Para actualizar la aplicaciÃ³n despuÃ©s del despliegue inicial:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Code Changes   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Git Commit     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ./deploy.sh    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Build Backend  â”‚  â”‚  Build Frontend â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Push to GCR    â”‚  â”‚  Push to GCR    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Deploy New     â”‚  â”‚  Deploy New     â”‚
â”‚  Revision       â”‚  â”‚  Revision       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Traffic Split  â”‚
         â”‚  (Gradual)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  100% to New    â”‚
         â”‚  Revision       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rollback si hay problemas:**
```bash
# Ver revisiones
gcloud run revisions list --service saas-dnd-backend

# Rollback a revisiÃ³n anterior
gcloud run services update-traffic saas-dnd-backend \
    --to-revisions REVISION_NAME=100
```

---

## ğŸ“Š Arquitectura Final

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Internet (HTTPS)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                             â”‚
                â–¼                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Cloud Run        â”‚         â”‚  Cloud Run        â”‚
    â”‚  Frontend         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Backend API      â”‚
    â”‚  (Nginx + React)  â”‚  CORS   â”‚  (Express.js)     â”‚
    â”‚                   â”‚         â”‚                   â”‚
    â”‚  â€¢ Port: 8080     â”‚         â”‚  â€¢ Port: 8080     â”‚
    â”‚  â€¢ CPU: 1         â”‚         â”‚  â€¢ CPU: 1         â”‚
    â”‚  â€¢ RAM: 256Mi     â”‚         â”‚  â€¢ RAM: 512Mi     â”‚
    â”‚  â€¢ Min: 0         â”‚         â”‚  â€¢ Min: 0         â”‚
    â”‚  â€¢ Max: 10        â”‚         â”‚  â€¢ Max: 10        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ Cloud SQL
                                            â”‚ Connector
                                            â”‚
                                            â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  Cloud SQL        â”‚
                                  â”‚  PostgreSQL 15    â”‚
                                  â”‚                   â”‚
                                  â”‚  â€¢ Tier: f1-micro â”‚
                                  â”‚  â€¢ Storage: 10GB  â”‚
                                  â”‚  â€¢ Backups: Daily â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  Secret Manager   â”‚
                                  â”‚                   â”‚
                                  â”‚  â€¢ JWT_SECRET     â”‚
                                  â”‚  â€¢ DATABASE_URL   â”‚
                                  â”‚  â€¢ SMTP_*         â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Comandos RÃ¡pidos

### Verificar Estado
```bash
# Ver todos los servicios
gcloud run services list

# Ver detalles de un servicio
gcloud run services describe saas-dnd-backend --region us-central1

# Ver logs en tiempo real
gcloud run services logs tail saas-dnd-backend --region us-central1
```

### Actualizar ConfiguraciÃ³n
```bash
# Actualizar variable de entorno
gcloud run services update saas-dnd-backend \
    --region us-central1 \
    --set-env-vars KEY=VALUE

# Actualizar secreto
echo -n "new-value" | gcloud secrets versions add SECRET_NAME --data-file=-

# Actualizar scaling
gcloud run services update saas-dnd-backend \
    --region us-central1 \
    --min-instances 1 \
    --max-instances 20
```

### Troubleshooting
```bash
# Ver Ãºltimos 100 logs
gcloud run services logs read saas-dnd-backend --limit 100

# Ver revisiones
gcloud run revisions list --service saas-dnd-backend

# Rollback
gcloud run services update-traffic saas-dnd-backend \
    --to-revisions PREVIOUS_REVISION=100
```

---

## ğŸ“š DocumentaciÃ³n Relacionada

- **PREREQUISITES.md** - Prerrequisitos detallados
- **QUICK_START_PREREQUISITES.md** - GuÃ­a rÃ¡pida de prerrequisitos
- **GOOGLE_CLOUD_RUN_DEPLOYMENT.md** - GuÃ­a completa de despliegue
- **DEPLOYMENT_CHECKLIST.md** - Checklist paso a paso
- **CLOUD_RUN_SUMMARY.md** - Resumen ejecutivo

---

**Ãšltima actualizaciÃ³n**: 28 de Diciembre, 2025  
**VersiÃ³n**: 1.0.0
