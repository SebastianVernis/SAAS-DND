# Google Cloud Run Deployment Scripts

This directory contains scripts for deploying SAAS-DND to Google Cloud Run.

## Scripts Overview

### 1. setup-gcp.sh
**Purpose**: Initial GCP project setup and configuration

**What it does**:
- Enables required GCP APIs
- Creates service accounts with proper permissions
- Sets up Cloud SQL PostgreSQL instance
- Creates secrets in Secret Manager
- Generates `.env.gcp` configuration file

**Usage**:
```bash
./setup-gcp.sh
```

**Prerequisites**:
- gcloud CLI installed and authenticated
- GCP project created with billing enabled

---

### 2. deploy.sh
**Purpose**: Deploy application to Cloud Run

**What it does**:
- Builds Docker images using Cloud Build
- Pushes images to Container Registry
- Deploys backend and frontend services
- Outputs service URLs

**Usage**:
```bash
./deploy.sh
```

**Prerequisites**:
- `setup-gcp.sh` completed successfully
- `.env.gcp` file exists

---

### 3. migrate-db.sh
**Purpose**: Run database migrations on Cloud SQL

**What it does**:
- Starts Cloud SQL Proxy
- Connects to Cloud SQL instance
- Runs Drizzle migrations
- Applies database schema

**Usage**:
```bash
./migrate-db.sh
```

**Prerequisites**:
- Cloud SQL instance created
- Backend dependencies installed

---

### 4. update-env.sh
**Purpose**: Update environment variables for deployed services

**What it does**:
- Updates environment variables without redeploying
- Supports backend and frontend services
- Interactive menu for easy updates

**Usage**:
```bash
./update-env.sh
```

**Prerequisites**:
- Services already deployed

---

## Quick Start

### First Time Deployment

```bash
# 1. Setup GCP
./setup-gcp.sh

# 2. Deploy services
./deploy.sh

# 3. Run database migrations
./migrate-db.sh

# 4. Update environment variables (if needed)
./update-env.sh
```

### Subsequent Deployments

```bash
# Just redeploy
./deploy.sh
```

---

## Configuration Files

### .env.gcp
Generated by `setup-gcp.sh`, contains:
- `PROJECT_ID`: Your GCP project ID
- `REGION`: Deployment region
- `CONNECTION_NAME`: Cloud SQL connection name
- `BACKEND_URL`: Backend service URL
- `FRONTEND_URL`: Frontend service URL

**Example**:
```bash
PROJECT_ID=my-project-123
REGION=us-central1
CONNECTION_NAME=my-project-123:us-central1:saas-dnd-db
BACKEND_URL=https://saas-dnd-backend-abc123-uc.a.run.app
FRONTEND_URL=https://saas-dnd-frontend-xyz789-uc.a.run.app
```

---

## Troubleshooting

### Script Fails with "Permission Denied"

```bash
chmod +x *.sh
```

### "gcloud: command not found"

Install Google Cloud SDK:
```bash
curl https://sdk.cloud.google.com | bash
exec -l $SHELL
gcloud init
```

### "Project not found"

Set your project:
```bash
gcloud config set project YOUR_PROJECT_ID
```

### Database Connection Issues

Check Cloud SQL instance status:
```bash
gcloud sql instances describe saas-dnd-db
```

### Deployment Timeout

Increase timeout in `cloudbuild.yaml`:
```yaml
timeout: '3600s'  # 1 hour
```

---

## Manual Commands

### View Logs
```bash
gcloud run services logs read saas-dnd-backend --region us-central1
```

### Update Service
```bash
gcloud run services update saas-dnd-backend \
    --region us-central1 \
    --set-env-vars KEY=VALUE
```

### Delete Service
```bash
gcloud run services delete saas-dnd-backend --region us-central1
```

### List Services
```bash
gcloud run services list
```

---

## Support

For detailed documentation, see:
- [GOOGLE_CLOUD_RUN_DEPLOYMENT.md](../../GOOGLE_CLOUD_RUN_DEPLOYMENT.md)
- [Cloud Run Documentation](https://cloud.google.com/run/docs)

For issues:
- GitHub: https://github.com/SebastianVernis/SAAS-DND/issues
